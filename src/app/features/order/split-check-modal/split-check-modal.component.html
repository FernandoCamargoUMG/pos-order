<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="start">
      <ion-button (click)="close()">
        <ion-icon slot="icon-only" name="close-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
    <ion-title>Dividir Cuenta - {{ tableName }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="toggleDragMode()" [color]="isDragMode ? 'warning' : 'light'">
        <ion-icon slot="start" name="swap-horizontal-outline"></ion-icon>
        {{ isDragMode ? 'Modo Arrastrar ON' : 'Activar Drag & Drop' }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding">
  <!-- Instrucciones cuando está en modo drag -->
  <div *ngIf="isDragMode" class="drag-instructions">
    <ion-icon name="arrow-forward-outline"></ion-icon>
    <p><strong>Modo Drag & Drop activado:</strong> Arrastra items entre cuentas para dividirlas</p>
  </div>

  <div class="header-section">
    <h2>Cuentas Activas ({{ ordersWithItems.length }})</h2>
    <ion-button (click)="createNewCheck()" color="success" size="small">
      <ion-icon slot="start" name="add-outline"></ion-icon>
      Nueva Cuenta
    </ion-button>
  </div>

  <div class="orders-grid" *ngIf="ordersWithItems.length > 0">
    <ion-grid>
      <ion-row>
        <ion-col size="12" size-md="6" *ngFor="let order of ordersWithItems">
          <ion-card 
            class="order-card"
            [class.drag-mode]="isDragMode"
            (dragover)="onDragOver($event)"
            (drop)="onDrop($event, order.id_local)">
            <ion-card-header>
              <div class="order-header">
                <div>
                  <ion-card-title>Cuenta #{{ order.id_local.slice(-6) }}</ion-card-title>
                  <p class="order-date">{{ order.created_at | date:'short' }}</p>
                </div>
                <ion-badge [color]="getStatusBadgeColor(order.status)">
                  {{ getStatusText(order.status) }}
                </ion-badge>
              </div>
            </ion-card-header>

            <ion-card-content>
              <!-- Items de la orden -->
              <ion-list class="items-list">
                <ion-item 
                  *ngFor="let item of order.items" 
                  lines="none"
                  [draggable]="isDragMode && order.status === 'OPEN'"
                  (dragstart)="onDragStart($event, item, order.id_local)"
                  [class.draggable]="isDragMode && order.status === 'OPEN'"
                  [class.not-draggable]="order.status !== 'OPEN'">
                  <ion-icon 
                    *ngIf="isDragMode && order.status === 'OPEN'" 
                    name="swap-horizontal-outline" 
                    slot="start"
                    class="drag-handle"></ion-icon>
                  <ion-label>
                    <h3>{{ item.quantity }}x {{ item.product_name }}</h3>
                    <p *ngIf="item.modifiers && item.modifiers.length > 0" class="modifiers">
                      {{ item.modifiers.join(', ') }}
                    </p>
                  </ion-label>
                  <ion-label slot="end" class="price">
                    Q{{ (item.price * item.quantity).toFixed(2) }}
                  </ion-label>
                </ion-item>
              </ion-list>

              <!-- Total -->
              <div class="order-total">
                <strong>Total:</strong>
                <span class="total-amount">Q{{ order.total.toFixed(2) }}</span>
              </div>

              <!-- Acciones -->
              <div class="order-actions">
                <ion-button 
                  *ngIf="order.status === 'OPEN'" 
                  (click)="editOrder(order)" 
                  expand="block" 
                  fill="outline"
                  color="primary"
                  size="small">
                  <ion-icon slot="start" name="create-outline"></ion-icon>
                  Editar
                </ion-button>

                <ion-button 
                  *ngIf="order.status === 'SENT'" 
                  (click)="markAsPaying(order)" 
                  expand="block" 
                  color="warning"
                  size="small">
                  <ion-icon slot="start" name="card-outline"></ion-icon>
                  Pagar
                </ion-button>
                
                <ion-button 
                  *ngIf="order.status === 'PAYING'" 
                  (click)="closeOrder(order)" 
                  expand="block" 
                  color="success"
                  size="small">
                  <ion-icon slot="start" name="checkmark-outline"></ion-icon>
                  Cerrar
                </ion-button>

                <p *ngIf="order.status === 'CLOSED'" class="closed-message">
                  <ion-icon name="checkmark-outline"></ion-icon>
                  Cuenta cerrada
                </p>
              </div>
            </ion-card-content>
          </ion-card>
        </ion-col>
      </ion-row>
    </ion-grid>
  </div>

  <div class="empty-state" *ngIf="ordersWithItems.length === 0">
    <ion-icon name="receipt-outline" size="large"></ion-icon>
    <p>No hay órdenes activas en esta mesa</p>
    <ion-button (click)="createNewCheck()" color="success">
      <ion-icon slot="start" name="add-outline"></ion-icon>
      Crear Primera Orden
    </ion-button>
  </div>
</ion-content>
